22:08:07|RAP|WARN|: Double free detected in function "do_getdents"
warning: Double free detected.
  --> src/filesystem/vfs/syscall/sys_getdents.rs:27:1
   |
27 | / fn do_getdents(
28 | |     args: &[usize],
29 | |     frame: &mut TrapFrame,
30 | |     format: DirentFormat,
31 | | ) -> Result<usize, SystemError> {
32 | |     let fd = args[0] as i32;
33 | |     let buf_vaddr = args[1];
34 | |     let len = args[2];
35 | |
36 | |     if buf_vaddr == 0 {
37 | |         return Err(SystemError::EFAULT);
38 | |     }
39 | |
40 | |     if len == 0 {
41 | |         return Err(SystemError::EINVAL);
42 | |     }
43 | |
44 | |     if len > MAX_GETDENTS_COUNT {
45 | |         return Err(SystemError::EINVAL);
46 | |     }
47 | |
48 | |     if fd < 0 {
49 | |         return Err(SystemError::EBADF);
50 | |     }
51 | |
52 | |     // 使用 UserBufferWriter 和 buffer_protected 创建受保护的用户缓冲区
53 | |     let from_user = frame.is_from_user();
54 | |     let mut writer = UserBufferWriter::new(buf_vaddr as *mut u8, len, from_user)?;
55 | |     let user_buf = writer.buffer_protected(0)?;
56 | |
57 | |     // 获取fd
58 | |     let binding = ProcessManager::current_pcb().fd_table();
59 | |     let fd_table_guard = binding.read();
60 | |     let file = fd_table_guard
61 | |         .get_file_by_fd(fd)
62 | |         .ok_or(SystemError::EBADF)?;
63 | |
64 | |     // drop guard 以避免无法调度的问题
65 | |     drop(fd_table_guard);
66 | |
67 | |     let mut ctx = FilldirContext::new(user_buf, format);
68 | |     match file.read_dir(&mut ctx) {
69 | |         Ok(_) => {
70 | |             if ctx.error.is_some() {
71 | |                 if ctx.error == Some(SystemError::EINVAL) {
72 | |                     return Ok(ctx.current_pos);
73 | |                 } else {
74 | |                     return Err(ctx.error.unwrap());
75 | |                 }
76 | |             }
77 | |             return Ok(ctx.current_pos);
78 | |         }
79 | |         Err(e) => {
80 | |             return Err(e);
81 | |         }
82 | |     }
83 | | }
   | |_- Double free (confidence 99%): Location in file src/filesystem/vfs/syscall/sys_getdents.rs line 27.
    | MIR detail: Value _84(_, src/filesystem/vfs/syscall/sys_getdents.rs:65) and _60(binding, src/filesystem/vfs/syscall/sys_getdents.rs:58) are alias.
    | MIR detail: _84(_, src/filesystem/vfs/syscall/sys_getdents.rs:65) is dropped at BB34(src/filesystem/vfs/syscall/sys_getdents.rs:65); _60(binding, src/filesystem/vfs/syscall/sys_getdents.rs:58) is dropped at BB52(src/filesystem/vfs/syscall/sys_getdents.rs:83).
   |
22:08:07|RAP|WARN|: Double free detected in function "do_getdents"
warning: Double free detected during unwinding.
  --> src/filesystem/vfs/syscall/sys_getdents.rs:27:1
   |
27 | / fn do_getdents(
28 | |     args: &[usize],
29 | |     frame: &mut TrapFrame,
30 | |     format: DirentFormat,
31 | | ) -> Result<usize, SystemError> {
32 | |     let fd = args[0] as i32;
33 | |     let buf_vaddr = args[1];
34 | |     let len = args[2];
35 | |
36 | |     if buf_vaddr == 0 {
37 | |         return Err(SystemError::EFAULT);
38 | |     }
39 | |
40 | |     if len == 0 {
41 | |         return Err(SystemError::EINVAL);
42 | |     }
43 | |
44 | |     if len > MAX_GETDENTS_COUNT {
45 | |         return Err(SystemError::EINVAL);
46 | |     }
47 | |
48 | |     if fd < 0 {
49 | |         return Err(SystemError::EBADF);
50 | |     }
51 | |
52 | |     // 使用 UserBufferWriter 和 buffer_protected 创建受保护的用户缓冲区
53 | |     let from_user = frame.is_from_user();
54 | |     let mut writer = UserBufferWriter::new(buf_vaddr as *mut u8, len, from_user)?;
55 | |     let user_buf = writer.buffer_protected(0)?;
56 | |
57 | |     // 获取fd
58 | |     let binding = ProcessManager::current_pcb().fd_table();
59 | |     let fd_table_guard = binding.read();
60 | |     let file = fd_table_guard
61 | |         .get_file_by_fd(fd)
62 | |         .ok_or(SystemError::EBADF)?;
63 | |
64 | |     // drop guard 以避免无法调度的问题
65 | |     drop(fd_table_guard);
66 | |
67 | |     let mut ctx = FilldirContext::new(user_buf, format);
68 | |     match file.read_dir(&mut ctx) {
69 | |         Ok(_) => {
70 | |             if ctx.error.is_some() {
71 | |                 if ctx.error == Some(SystemError::EINVAL) {
72 | |                     return Ok(ctx.current_pos);
73 | |                 } else {
74 | |                     return Err(ctx.error.unwrap());
75 | |                 }
76 | |             }
77 | |             return Ok(ctx.current_pos);
78 | |         }
79 | |         Err(e) => {
80 | |             return Err(e);
81 | |         }
82 | |     }
83 | | }
   | |_- Double free (confidence 99%): Location in file src/filesystem/vfs/syscall/sys_getdents.rs line 27.
    | MIR detail: Value _84(_, src/filesystem/vfs/syscall/sys_getdents.rs:65) and _60(binding, src/filesystem/vfs/syscall/sys_getdents.rs:58) are alias.
    | MIR detail: _84(_, src/filesystem/vfs/syscall/sys_getdents.rs:65) is dropped at BB34(src/filesystem/vfs/syscall/sys_getdents.rs:65); _60(binding, src/filesystem/vfs/syscall/sys_getdents.rs:58) is dropped at BB61(src/filesystem/vfs/syscall/sys_getdents.rs:83).
   |
render dot for DefId(0:20008 ~ dragonos_kernel[9e38]::filesystem::vfs::syscall::sys_getdents::do_getdents)
