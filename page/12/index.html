<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report #12: Dragon Bugs</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">← Back to Directory</a>
        
        <h1>
            Report #12
            
                 <span class="func-name">libs::rwlock::{impl#6}::downgrade</span>
            
        </h1>


        <div class="two-column">
            
                <div class="column">
                    <div class="file-header">
                        <h2>Log Content</h2>
                        <button class="copy-btn" onclick="copyText('logContent')">Copy</button>
                    </div>
                    <pre id="logContent" class="code-block scrollable">22:07:53|RAP|WARN|: Use-after-free detected in function &#34;downgrade&#34;
warning: Use-after-free detected.
   --&gt; src/libs/rwlock.rs:462:9
    |
452 |   pub fn downgrade(mut self) -&gt; RwLockReadGuard&lt;&#39;rwlock, T&gt; {
453 |           while self.inner.current_reader().is_err() {
454 |               spin_loop();
455 |           }
456 |
457 |           let inner: &amp;RwLock&lt;T&gt; = self.inner;
458 |           let irq_guard = self.irq_guard.take();
459 |           // 自动移去UPGRADED比特位
460 |           mem::drop(self);
461 |
462 | /         RwLockReadGuard {
463 | |             data: unsafe { &amp;*inner.data.get() },
464 | |             lock: &amp;inner.lock,
465 | |             irq_guard,
466 | |         }
    | |_________- Use-after-free (confidence 99%): Location in file src/libs/rwlock.rs line 462.
    | MIR detail: Value _16(_, src/libs/rwlock.rs:460) and _23(_, src/libs/rwlock.rs:465) are alias.
    | MIR detail: _16(_, src/libs/rwlock.rs:460) is dropped at BB7(src/libs/rwlock.rs:460); _23(_, src/libs/rwlock.rs:465) is used at BB15(src/libs/rwlock.rs:467).
467 |       }
    |
warning: Use-after-free detected.
   --&gt; src/libs/rwlock.rs:465:13
    |
452 | pub fn downgrade(mut self) -&gt; RwLockReadGuard&lt;&#39;rwlock, T&gt; {
453 |         while self.inner.current_reader().is_err() {
454 |             spin_loop();
455 |         }
456 |
457 |         let inner: &amp;RwLock&lt;T&gt; = self.inner;
458 |         let irq_guard = self.irq_guard.take();
459 |         // 自动移去UPGRADED比特位
460 |         mem::drop(self);
461 |
462 |         RwLockReadGuard {
463 |             data: unsafe { &amp;*inner.data.get() },
464 |             lock: &amp;inner.lock,
465 |             irq_guard,
    |             --------- Use-after-free (confidence 99%): Location in file src/libs/rwlock.rs line 465.
    | MIR detail: Value _16(_, src/libs/rwlock.rs:460) and _13(irq_guard, src/libs/rwlock.rs:458) are alias.
    | MIR detail: _16(_, src/libs/rwlock.rs:460) is dropped at BB7(src/libs/rwlock.rs:460); _13(irq_guard, src/libs/rwlock.rs:458) is used at BB15(src/libs/rwlock.rs:467).
466 |         }
467 |     }
    |
22:07:53|RAP|WARN|: Dangling pointer detected in function &#34;downgrade&#34;
warning: Dangling pointer detected.
   --&gt; src/libs/rwlock.rs:452:1
    |
452 | / pub fn downgrade(mut self) -&gt; RwLockReadGuard&lt;&#39;rwlock, T&gt; {
453 | |         while self.inner.current_reader().is_err() {
454 | |             spin_loop();
455 | |         }
456 | |
457 | |         let inner: &amp;RwLock&lt;T&gt; = self.inner;
458 | |         let irq_guard = self.irq_guard.take();
459 | |         // 自动移去UPGRADED比特位
460 | |         mem::drop(self);
461 | |
462 | |         RwLockReadGuard {
463 | |             data: unsafe { &amp;*inner.data.get() },
464 | |             lock: &amp;inner.lock,
465 | |             irq_guard,
466 | |         }
467 | |     }
    | |_____- Dangling pointer (confidence 99%): Location in file src/libs/rwlock.rs line 452.
    | MIR detail: Value _16(_, src/libs/rwlock.rs:460) and _0(_, src/libs/rwlock.rs:452) are alias.
    | MIR detail: _16(_, src/libs/rwlock.rs:460) is dropped at BB7(src/libs/rwlock.rs:460); _0(_, src/libs/rwlock.rs:452) became dangling.
    |
render dot for DefId(0:5191 ~ dragonos_kernel[9e38]::libs::rwlock::{impl#6}::downgrade)
</pre>
                </div>
            

            
                <div class="column">
                    <div class="file-header">
                        <h2>MIR Content</h2>
                        <button class="copy-btn" onclick="copyText('mirContent')">Copy</button>
                    </div>
                    <div id="mirContent" class="mir-content scrollable">bb0 at src/libs/rwlock.rs:453:9: 455:10
bb1 at src/libs/rwlock.rs:453:15: 453:51
bb2 at src/libs/rwlock.rs:453:15: 453:42
bb4 at src/libs/rwlock.rs:453:50: 453:51
bb5 at src/libs/rwlock.rs:454:24: 454:25
bb6 at src/libs/rwlock.rs:453:50: 453:51
bb7 at src/libs/rwlock.rs:458:45: 458:46
bb8 at src/libs/rwlock.rs:460:23: 460:24
bb9 at src/libs/rwlock.rs:463:45: 463:46
bb14 at src/libs/rwlock.rs:463:28: 463:46
bb15 at src/libs/rwlock.rs:463:28: 463:46
fn libs::rwlock::RwLockUpgradableGuard::&lt;&#39;rwlock, T&gt;::downgrade
_0:  @ libs::rwlock::RwLockReadGuard&lt;&#39;{erased}, T/#1&gt; 
_1:  @ libs::rwlock::RwLockUpgradableGuard&lt;&#39;{erased}, T/#1&gt; 
_2:  @ () 
_3:  @ () 
_4:  @ bool 
_5:  @ &amp;&#39;{erased} core::result::Result&lt;u32, system_error::SystemError&gt; 
_6:  @ core::result::Result&lt;u32, system_error::SystemError&gt; 
_7:  @ &amp;&#39;{erased} libs::rwlock::RwLock&lt;T/#1&gt; 
_8:  @ () 
_9:  @ ! 
_10:  @ () 
_11:  @ ! 
_12:  @ &amp;&#39;{erased} libs::rwlock::RwLock&lt;T/#1&gt; 
_13:  @ core::option::Option&lt;exception::IrqFlagsGuard&gt; 
_14:  @ &amp;&#39;{erased} mut core::option::Option&lt;exception::IrqFlagsGuard&gt; 
_15:  @ () 
_16:  @ libs::rwlock::RwLockUpgradableGuard&lt;&#39;{erased}, T/#1&gt; 
_17:  @ *const T/#1 
_18:  @ &amp;&#39;{erased} T/#1 
_19:  @ *mut T/#1 
_20:  @ &amp;&#39;{erased} core::cell::UnsafeCell&lt;T/#1&gt; 
_21:  @ &amp;&#39;{erased} core::sync::atomic::AtomicU32 
_22:  @ &amp;&#39;{erased} core::sync::atomic::AtomicU32 
_23:  @ core::option::Option&lt;exception::IrqFlagsGuard&gt; 
_24:  @ &amp;&#39;{erased} libs::rwlock::RwLock&lt;T/#1&gt; 
_25:  @ &amp;&#39;{erased} libs::rwlock::RwLock&lt;T/#1&gt; 
_26:  @ bool 
_27:  @ *const () 
_28:  @ usize 
_29:  @ usize 
_30:  @ usize 
_31:  @ usize 
_32:  @ bool 
_33:  @ *const () 
_34:  @ usize 
_35:  @ bool 
_36:  @ bool 
_37:  @ bool 

bb 0 {
CleanUp: false
    Assign((_26, const false)) @ _26=const false @ Use
    Assign((_26, const true)) @ _26=const true @ Use
    StorageLive(_2) @ StorageLive
    goto -&gt; bb1 @ Goto
}
bb 1 {
CleanUp: false
    StorageLive(_4) @ StorageLive
    StorageLive(_5) @ StorageLive
    StorageLive(_6) @ StorageLive
    StorageLive(_7) @ StorageLive
    Assign((_24, deref_copy (_1.1: &amp;libs::rwlock::RwLock&lt;T&gt;))) @ _24=deref_copy (_1.1: &amp;libs::rwlock::RwLock&lt;T&gt;) @ CopyForDeref
    Assign((_7, &amp;(*_24))) @ _7=&amp;(*_24) @ Ref
    _6 = libs::rwlock::RwLock::&lt;T&gt;::current_reader(move _7) -&gt; [return: bb2, unwind: bb13] @ Call: FnDid: 5152
}
bb 2 {
CleanUp: false
    Assign((_5, &amp;_6)) @ _5=&amp;_6 @ Ref
    StorageDead(_7) @ StorageDead
    _4 = core::result::Result::&lt;u32, system_error::SystemError&gt;::is_err(move _5) -&gt; [return: bb3, unwind: bb13] @ Call: FnDid: 10990
}
bb 3 {
CleanUp: false
    switchInt(move _4) -&gt; [0: bb6, otherwise: bb4] @ SwitchInt
}
bb 4 {
CleanUp: false
    StorageDead(_6) @ StorageDead
    StorageDead(_5) @ StorageDead
    StorageLive(_8) @ StorageLive
    _8 = core::hint::spin_loop() -&gt; [return: bb5, unwind: bb13] @ Call: FnDid: 1452
}
bb 5 {
CleanUp: false
    StorageDead(_8) @ StorageDead
    Assign((_3, const ())) @ _3=const () @ Use
    StorageDead(_4) @ StorageDead
    goto -&gt; bb1 @ Goto
}
bb 6 {
CleanUp: false
    StorageDead(_6) @ StorageDead
    StorageDead(_5) @ StorageDead
    StorageLive(_10) @ StorageLive
    Assign((_2, const ())) @ _2=const () @ Use
    StorageDead(_10) @ StorageDead
    StorageDead(_4) @ StorageDead
    StorageDead(_2) @ StorageDead
    StorageLive(_12) @ StorageLive
    Assign((_25, deref_copy (_1.1: &amp;libs::rwlock::RwLock&lt;T&gt;))) @ _25=deref_copy (_1.1: &amp;libs::rwlock::RwLock&lt;T&gt;) @ CopyForDeref
    Assign((_12, &amp;(*_25))) @ _12=&amp;(*_25) @ Ref
    StorageLive(_13) @ StorageLive
    StorageLive(_14) @ StorageLive
    Assign((_14, &amp;mut (_1.2: core::option::Option&lt;exception::IrqFlagsGuard&gt;))) @ _14=&amp;mut (_1.2: core::option::Option&lt;exception::IrqFlagsGuard&gt;) @ Ref
    _13 = core::option::Option::&lt;exception::IrqFlagsGuard&gt;::take(move _14) -&gt; [return: bb7, unwind: bb13] @ Call: FnDid: 10206
}
bb 7 {
CleanUp: false
    StorageDead(_14) @ StorageDead
    StorageLive(_15) @ StorageLive
    StorageLive(_16) @ StorageLive
    Assign((_26, const false)) @ _26=const false @ Use
    Assign((_16, move _1)) @ _16=move _1 @ Use
    _15 = core::mem::drop::&lt;libs::rwlock::RwLockUpgradableGuard&lt;&#39;_, T&gt;&gt;(move _16) -&gt; [return: bb8, unwind: bb10] @ Call: FnDid: 2323
}
bb 8 {
CleanUp: false
    StorageDead(_16) @ StorageDead
    StorageDead(_15) @ StorageDead
    StorageLive(_17) @ StorageLive
    StorageLive(_18) @ StorageLive
    StorageLive(_19) @ StorageLive
    StorageLive(_20) @ StorageLive
    Assign((_20, &amp;((*_12).1: core::cell::UnsafeCell&lt;T&gt;))) @ _20=&amp;((*_12).1: core::cell::UnsafeCell&lt;T&gt;) @ Ref
    _19 = core::cell::UnsafeCell::&lt;T&gt;::get(move _20) -&gt; [return: bb9, unwind: bb10] @ Call: FnDid: 5687
}
bb 9 {
CleanUp: false
    StorageDead(_20) @ StorageDead
    Assign((_27, copy _19 as *const () (PtrToPtr))) @ _27=copy _19 as *const () (PtrToPtr) @ Cast
    Assign((_28, copy _27 as usize (Transmute))) @ _28=copy _27 as usize (Transmute) @ Cast
    Assign((_29, AlignOf(T))) @ _29=AlignOf(T) @ NullaryOp
    Assign((_30, Sub(copy _29, const 1_usize))) @ _30=Sub(copy _29, const 1_usize) @ BinaryOp
    Assign((_31, BitAnd(copy _28, copy _30))) @ _31=BitAnd(copy _28, copy _30) @ BinaryOp
    Assign((_32, Eq(copy _31, const 0_usize))) @ _32=Eq(copy _31, const 0_usize) @ BinaryOp
    assert(copy _32, &#34;misaligned pointer dereference: address must be a multiple of {} but is {}&#34;, copy _29, copy _28) -&gt; [success: bb14, unwind unreachable] @ Assert
}
bb 10 {
CleanUp: true
    drop(_13) -&gt; [return: bb13, unwind terminate(cleanup)] @ Drop
}
bb 11 {
CleanUp: true
    resume @ UnwindResume
}
bb 12 {
CleanUp: true
    drop(_1) -&gt; [return: bb11, unwind terminate(cleanup)] @ Drop
}
bb 13 {
CleanUp: true
    switchInt(copy _26) -&gt; [0: bb11, otherwise: bb12] @ SwitchInt
}
bb 14 {
CleanUp: false
    Assign((_33, copy _19 as *const () (PtrToPtr))) @ _33=copy _19 as *const () (PtrToPtr) @ Cast
    Assign((_34, copy _33 as usize (Transmute))) @ _34=copy _33 as usize (Transmute) @ Cast
    Assign((_35, Eq(copy _34, const 0_usize))) @ _35=Eq(copy _34, const 0_usize) @ BinaryOp
    Assign((_36, BitAnd(copy _35, const true))) @ _36=BitAnd(copy _35, const true) @ BinaryOp
    Assign((_37, Not(copy _36))) @ _37=Not(copy _36) @ UnaryOp
    assert(copy _37, &#34;null pointer dereference occurred&#34;) -&gt; [success: bb15, unwind unreachable] @ Assert
}
bb 15 {
CleanUp: false
    Assign((_18, &amp;(*_19))) @ _18=&amp;(*_19) @ Ref
    Assign((_17, &amp;raw const (*_18))) @ _17=&amp;raw const (*_18) @ RawPtr
    StorageLive(_21) @ StorageLive
    StorageLive(_22) @ StorageLive
    Assign((_22, &amp;((*_12).0: core::sync::atomic::AtomicU32))) @ _22=&amp;((*_12).0: core::sync::atomic::AtomicU32) @ Ref
    Assign((_21, &amp;(*_22))) @ _21=&amp;(*_22) @ Ref
    StorageLive(_23) @ StorageLive
    Assign((_23, move _13)) @ _23=move _13 @ Use
    Assign((_0, libs::rwlock::RwLockReadGuard::&lt;&#39;_, T&gt; { data: move _17, lock: move _21, irq_guard: move _23 })) @ _0=libs::rwlock::RwLockReadGuard::&lt;&#39;_, T&gt; { data: move _17, lock: move _21, irq_guard: move _23 } @ Aggregate
    StorageDead(_23) @ StorageDead
    StorageDead(_21) @ StorageDead
    StorageDead(_17) @ StorageDead
    StorageDead(_13) @ StorageDead
    StorageDead(_12) @ StorageDead
    StorageDead(_22) @ StorageDead
    StorageDead(_19) @ StorageDead
    StorageDead(_18) @ StorageDead
    return @ Return
}

</div>
                </div>
            
        </div>

        
    </div>
    <script>
    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert('Copied!');
        });
    }
    </script>
</body>
</html>
